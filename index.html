<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D Escape Room - Challenge Edition</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.9.1/gsap.min.js"></script>
    
    <style>
        :root {
            --primary: #4fc3f7;
            --accent: #ff4081;
            --success: #00e676;
            --glass: rgba(255, 255, 255, 0.1);
        }

        body { 
            margin: 0; font-family: 'Segoe UI', sans-serif; 
            background: #050505; color: white; overflow: hidden; height: 100vh;
        }

        #canvas-container { position: fixed; top: 0; left: 0; z-index: 0; }

        .ui-layer {
            position: relative; z-index: 10; display: flex;
            justify-content: center; align-items: center; height: 100vh; pointer-events: none;
        }

        .card {
            background: rgba(10, 10, 20, 0.85); backdrop-filter: blur(15px);
            padding: 2.5rem; border-radius: 24px; border: 1px solid rgba(79, 195, 247, 0.3);
            text-align: center; width: 90%; max-width: 500px; pointer-events: auto;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
        }

        /* Level Animation Overlay */
        #level-intro {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; justify-content: center; align-items: center;
            z-index: 100; background: rgba(0,0,0,0.9); pointer-events: none;
        }

        .lvl-text {
            font-size: 5rem; font-weight: 900; color: var(--primary);
            text-transform: uppercase; letter-spacing: 10px;
            opacity: 0; transform: scale(0.5);
        }

        /* Choice Grid */
        .choice-container {
            display: flex; justify-content: space-around; margin-top: 20px;
        }

        .object-choice {
            cursor: pointer; transition: transform 0.3s; padding: 15px;
            border-radius: 15px; background: rgba(255,255,255,0.05);
            border: 1px solid transparent;
        }

        .object-choice:hover { 
            transform: scale(1.1); 
            border-color: var(--primary);
            background: rgba(79, 195, 247, 0.1);
        }

        .object-icon { font-size: 4rem; display: block; margin-bottom: 10px; }

        .btn {
            background: var(--glass); border: 1px solid var(--primary);
            color: white; padding: 15px 25px; border-radius: 12px;
            cursor: pointer; font-weight: bold; transition: all 0.3s;
            margin: 5px;
        }

        .btn:hover { background: var(--primary); color: #000; box-shadow: 0 0 20px var(--primary); }

        input {
            background: rgba(0,0,0,0.5); border: 2px solid var(--glass);
            padding: 15px; border-radius: 10px; color: white; width: 100%;
            box-sizing: border-box; font-size: 1.2rem; text-align: center; outline: none;
        }

        .hidden { display: none !important; }
        
        #feedback { margin: 15px 0; font-weight: bold; min-height: 1.2em; }

        /* Back button style */
        .btn-back {
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.3);
            margin-top: 20px;
            padding: 10px 20px;
            font-size: 0.9rem;
            width: auto;
        }
        
        .btn-back:hover {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border-color: white;
            box-shadow: none;
        }

        /* Game over screen */
        .game-complete {
            animation: celebrate 2s infinite alternate;
        }

        @keyframes celebrate {
            0% { transform: scale(1); }
            100% { transform: scale(1.05); }
        }

        .fireworks {
            font-size: 3rem;
            animation: fireworks 1s infinite;
        }

        @keyframes fireworks {
            0%, 100% { transform: translateY(0) rotate(0deg); }
            50% { transform: translateY(-20px) rotate(180deg); }
        }

        /* Wrong door message styling */
        .wrong-door-message {
            background: rgba(255, 64, 129, 0.2);
            padding: 15px;
            border-radius: 10px;
            border: 2px solid var(--accent);
            margin: 15px 0;
            animation: pulse 0.5s infinite alternate;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            100% { transform: scale(1.02); }
        }
    </style>
</head>
<body>

    <div id="canvas-container"></div>

    <div id="level-intro" class="hidden">
        <div class="lvl-text" id="lvl-anim-text">Level 1</div>
    </div>

    <div class="ui-layer">
        <!-- Screen 1: Start -->
        <div id="screen-start" class="card">
            <h1 style="color:var(--primary); font-size: 2.5rem;">ESCAPE ROOM</h1>
            <p>Select your subject and complete 5 levels</p>
            <button class="btn" onclick="transitionTo('screen-subjects')">ENTER GAME</button>
        </div>

        <!-- Screen 2: Subjects -->
        <div id="screen-subjects" class="card hidden">
            <h2>Select Subject</h2>
            <div style="display: grid; gap: 15px; margin-top: 20px;">
                <button class="btn" onclick="startGame('Maths')">MATHS</button>
                <button class="btn" onclick="startGame('Python')">PYTHON</button>
                <button class="btn" onclick="startGame('English')">ENGLISH</button>
            </div>
            
            <!-- Add back button -->
            <button class="btn btn-back" onclick="transitionTo('screen-start')">
                ‚Üê BACK TO MAIN MENU
            </button>
        </div>

        <!-- Screen 3: Choice Screen -->
        <div id="screen-choice" class="card hidden">
            <h2 id="choice-title">Level 1</h2>
            <p>Pick a path to reveal your question</p>
            <div class="choice-container" id="objects-grid"></div>
            
            <!-- Add back button to go back to subject selection -->
            <button class="btn btn-back" onclick="transitionTo('screen-subjects')">
                ‚Üê CHOOSE ANOTHER SUBJECT
            </button>
        </div>

        <!-- Screen 4: Question Screen -->
        <div id="screen-game" class="card hidden">
            <div style="display: flex; justify-content: space-between; color: var(--primary); font-family: monospace;">
                <span>LVL: <b id="lvl-display">1</b>/5</span>
                <span>SCORE: <b id="score-display">0</b></span>
            </div>
            <h3 id="subject-title" style="color:var(--primary)">SUBJECT</h3>
            <p id="question-text" style="font-size: 1.1rem; min-height: 50px;"></p>
            
            <input type="text" id="user-ans" placeholder="Type answer here...">
            <div id="feedback"></div>
            
            <button id="submit-btn" class="btn" style="width:100%; background: var(--accent);" onclick="checkAnswer()">SUBMIT ANSWER</button>
            
            <!-- Add back button to go back to object selection -->
            <button class="btn btn-back" onclick="goBackToChoice()">
                ‚Üê BACK TO OBJECTS
            </button>
        </div>

        <!-- Screen 5: Wrong Door Message -->
        <div id="screen-wrong-door" class="card hidden">
            <div style="font-size: 5rem; margin: 20px 0;">‚ùå</div>
            <h2 style="color:var(--accent);">OOPS!</h2>
            <div id="wrong-door-message" class="wrong-door-message">
                <p id="wrong-object-text" style="font-size: 1.2rem; margin: 0;">
                    <!-- Message will be inserted here -->
                </p>
            </div>
            <p id="restart-message" style="margin-top: 20px; color: #aaa;">
                <!-- Restart message will be inserted here -->
            </p>
        </div>

        <!-- Screen 6: Game Complete Screen -->
        <div id="screen-complete" class="card hidden game-complete">
            <div class="fireworks">üéâ</div>
            <h2 style="color:var(--success);">YAHHH!!</h2>
            <p style="font-size: 1.5rem; font-weight: bold; color: var(--primary);">
                You passed all the mission successfully!
            </p>
            <p style="font-size: 1.2rem; margin: 20px 0;">
                Final Score: <span id="final-score" style="font-size: 2rem; color: var(--success); font-weight: bold;">0</span>
            </p>
            <p style="color: #aaa; margin-bottom: 30px;">
                Subject: <span id="completed-subject" style="color: var(--primary); font-weight: bold;">Maths</span>
            </p>
            
            <button class="btn" onclick="playAgain()" style="background: var(--success);">
                PLAY AGAIN
            </button>
            <button class="btn btn-back" onclick="goToSubjects()">
                ‚Üê CHOOSE ANOTHER SUBJECT
            </button>
        </div>
    </div>

    <script>
        // --- 3D BACKGROUND ---
        let scene, camera, renderer, starSphere, particles;
        function init3D() {
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            document.getElementById('canvas-container').appendChild(renderer.domElement);
            starSphere = new THREE.Mesh(new THREE.SphereGeometry(10, 32, 32), new THREE.MeshBasicMaterial({ color: 0x4fc3f7, wireframe: true, transparent: true, opacity: 0.2 }));
            scene.add(starSphere);
            const pGeom = new THREE.BufferGeometry();
            const coords = new Float32Array(1500 * 3);
            for(let i=0; i<4500; i++) coords[i] = (Math.random() - 0.5) * 100;
            pGeom.setAttribute('position', new THREE.BufferAttribute(coords, 3));
            particles = new THREE.Points(pGeom, new THREE.PointsMaterial({ color: 0xffffff, size: 0.1 }));
            scene.add(particles);
            camera.position.z = 25;
        }
        function animate() {
            requestAnimationFrame(animate);
            starSphere.rotation.y += 0.002;
            particles.rotation.y -= 0.0005;
            renderer.render(scene, camera);
        }

        // --- GAME LOGIC ---
        let currentSub = "";
        let level = 1;
        let score = 0;
        let currentAnswer = "";
        let wrongDoorIndex = -1; // Track which door is wrong
        let usedQuestions = new Set(); // Track used questions

        const levelConfig = {
            1: { name: "Doors", icon: "üö™", colors: ["#ff5252", "#4fc3f7", "#ffd740"] },
            2: { name: "Buckets", icon: "ü™£", colors: ["#ea80fc", "#b2ff59", "#00e5ff"] },
            3: { name: "Stones", icon: "ü™®", colors: ["#9e9e9e", "#795548", "#607d8b"] },
            4: { name: "Books", icon: "üìñ", colors: ["#ff9100", "#f50057", "#3d5afe"] },
            5: { name: "Cards", icon: "üÉè", colors: ["#ffffff", "#ff1744", "#212121"] }
        };

        const questions = {
            Maths: [
                {q:"8 x 8?", a:"64"}, {q:"‚àö144?", a:"12"}, {q:"15 + 27?", a:"42"}, 
                {q:"100 √∑ 4?", a:"25"}, {q:"3 cubed (3¬≥)?", a:"27"}, {q:"7 x 9?", a:"63"},
                {q:"Square side 5, Perimeter?", a:"20"}, {q:"12 x 4?", a:"48"},
                {q:"What is 9 √ó 6?", a:"54"}, {q:"What is 144 √∑ 12?", a:"12"},
                {q:"What is 13 + 29?", a:"42"}, {q:"What is 81 √∑ 9?", a:"9"},
                {q:"What is 5 √ó 11?", a:"55"}, {q:"What is 72 √∑ 8?", a:"9"},
                {q:"What is 14 √ó 3?", a:"42"}, {q:"What is 100 - 57?", a:"43"}
            ],
            Python: [
                {q:"Output of 5+3?", a:"8"}, {q:"Comment symbol?", a:"#"}, {q:"Function keyword?", a:"def"},
                {q:"2 ** 3?", a:"8"}, {q:"Modulo of 10 % 3?", a:"1"}, {q:"List add method?", a:"append"},
                {q:"Boolean of 0?", a:"false"}, {q:"String convert func?", a:"str"},
                {q:"Output of print('Hi'*2)?", a:"hihi"}, {q:"Loop keyword?", a:"for"},
                {q:"Output of 3 > 5?", a:"false"}, {q:"Output of 7 == 7?", a:"true"},
                {q:"What does int() do?", a:"convert"}, {q:"Data type for decimals?", a:"float"},
                {q:"Import keyword?", a:"import"}, {q:"Output of 'a' in 'apple'?", a:"true"}
            ],
            English: [
                {q:"Plural of 'child'?", a:"children"}, {q:"Opposite of 'UP'?", a:"down"}, {q:"Past of 'go'?", a:"went"},
                {q:"Synonym for 'big'?", a:"large"}, {q:"Article for 'apple'?", a:"an"}, {q:"Capital of France?", a:"paris"},
                {q:"Plural of 'mouse'?", a:"mice"}, {q:"Opposite of 'hot'?", a:"cold"},
                {q:"How many vowels in 'computer'?", a:"3"}, {q:"Past of 'eat'?", a:"ate"},
                {q:"Article for 'hour'?", a:"an"}, {q:"Plural of 'foot'?", a:"feet"},
                {q:"Comparative of 'good'?", a:"better"}, {q:"Capital of Japan?", a:"tokyo"},
                {q:"Antonym of 'dark'?", a:"light"}, {q:"Synonym for 'happy'?", a:"joyful"}
            ]
        };

        function transitionTo(screenId) {
            document.querySelectorAll('.card').forEach(c => c.classList.add('hidden'));
            const next = document.getElementById(screenId);
            next.classList.remove('hidden');
            gsap.fromTo(next, {opacity:0, y:20}, {opacity:1, y:0, duration:0.5});
        }

        function startGame(sub) {
            currentSub = sub;
            level = 1;
            score = 0;
            usedQuestions.clear(); // Clear used questions when starting new game
            startLevelSequence();
        }

        function startLevelSequence() {
            if (level > 5) {
                // Game completed - show victory screen
                document.getElementById('final-score').textContent = score;
                document.getElementById('completed-subject').textContent = currentSub;
                transitionTo('screen-complete');
                return;
            }

            const intro = document.getElementById('level-intro');
            const text = document.getElementById('lvl-anim-text');
            intro.classList.remove('hidden');
            text.innerText = `LEVEL ${level}`;
            
            gsap.fromTo(text, 
                { opacity: 0, scale: 0.5 }, 
                { opacity: 1, scale: 1.2, duration: 0.8, ease: "back.out", onComplete: () => {
                    gsap.to(text, { opacity: 0, scale: 2, duration: 0.4, delay: 0.6, onComplete: () => {
                        intro.classList.add('hidden');
                        showChoicePhase();
                    }});
                }}
            );
        }

        function showChoicePhase() {
            const config = levelConfig[level];
            document.getElementById('choice-title').innerText = `Level ${level}: Choose a ${config.name.slice(0,-1)}`;
            const grid = document.getElementById('objects-grid');
            grid.innerHTML = "";

            // Randomly select which door is wrong (1 out of 3)
            wrongDoorIndex = Math.floor(Math.random() * 3);

            for (let i = 0; i < 3; i++) {
                const div = document.createElement('div');
                div.className = "object-choice";
                div.innerHTML = `
                    <span class="object-icon" style="color:${config.colors[i]}">${config.icon}</span>
                    <small>Path ${i+1}</small>
                `;
                // Store door index as data attribute
                div.dataset.index = i;
                div.onclick = () => selectObject(i);
                grid.appendChild(div);
            }
            transitionTo('screen-choice');
        }

        function selectObject(objectIndex) {
            if (objectIndex === wrongDoorIndex) {
                // Wrong door selected - show special message screen
                const config = levelConfig[level];
                const objectName = config.name.slice(0, -1).toLowerCase(); // door, bucket, stone, book, card
                
                // Set the messages
                document.getElementById('wrong-object-text').innerHTML = `
                    You have chosen the wrong ${objectName}!<br>
                    <small style="color: #ffcccb;">This ${objectName} leads nowhere...</small>
                `;
                
                document.getElementById('restart-message').innerHTML = `
                    <span style="color: var(--accent); font-weight: bold;">Restarting the game...</span>
                `;
                
                // Show wrong door screen
                transitionTo('screen-wrong-door');
                
                // Add shake animation
                gsap.to(".card", { 
                    x: 10, 
                    duration: 0.1, 
                    repeat: 5, 
                    yoyo: true 
                });
                
                // Red color effect on 3D sphere
                gsap.to(starSphere.material.color, { 
                    r: 1, g: 0, b: 0, 
                    duration: 0.5 
                });
                
                // Explosion effect
                gsap.to(starSphere.scale, {
                    x: 0.7, y: 0.7, z: 0.7,
                    duration: 0.5,
                    ease: "back.out(1.7)"
                });
                
                // Restart game after 2.5 seconds (gives time to read messages)
                setTimeout(() => {
                    startGame(currentSub); // Restart with same subject
                }, 2500);
            } else {
                // Correct door - load question
                loadQuestion();
            }
        }

        function loadQuestion() {
            let availableQuestions = questions[currentSub].filter((q, index) => !usedQuestions.has(index));
            
            // If all questions have been used, reset the used questions
            if (availableQuestions.length === 0) {
                usedQuestions.clear();
                availableQuestions = questions[currentSub];
            }
            
            // Pick random question from available ones
            const randomIndex = Math.floor(Math.random() * availableQuestions.length);
            const randomQ = availableQuestions[randomIndex];
            
            // Find the original index to mark as used
            const originalIndex = questions[currentSub].findIndex(q => q.q === randomQ.q && q.a === randomQ.a);
            usedQuestions.add(originalIndex);
            
            currentAnswer = randomQ.a.toLowerCase();
            document.getElementById('question-text').innerText = randomQ.q;
            document.getElementById('lvl-display').innerText = level;
            document.getElementById('score-display').innerText = score;
            document.getElementById('subject-title').innerText = currentSub.toUpperCase();
            document.getElementById('user-ans').value = "";
            document.getElementById('feedback').innerText = "";
            
            transitionTo('screen-game');
            setTimeout(() => document.getElementById('user-ans').focus(), 500);
        }

        function checkAnswer() {
            const val = document.getElementById('user-ans').value.toLowerCase().trim();
            const feed = document.getElementById('feedback');

            if (val === currentAnswer) {
                feed.innerHTML = "<span style='color:var(--success)'>‚úÖ CORRECT! Proceeding to next level....</span>";
                score += 20;
                level++;
                gsap.to(starSphere.material.color, { r: 0, g: 1, b: 0, duration: 0.5, yoyo: true, repeat: 1 });
                setTimeout(startLevelSequence, 1200);
            } else {
                feed.innerHTML = "<span style='color:var(--accent)'>‚ùå WRONG! Game restarting...</span>";
                gsap.to(".card", { x: 10, repeat: 5, yoyo: true, duration: 0.05 });
                gsap.to(starSphere.material.color, { r: 1, g: 0, b: 0, duration: 0.5 });
                
                // Restart game after delay
                setTimeout(() => {
                    startGame(currentSub); // Restart with same subject
                }, 1500);
            }
        }

        // Navigation functions
        function goBackToChoice() {
            transitionTo('screen-choice');
        }

        function playAgain() {
            startGame(currentSub);
        }

        function goToSubjects() {
            transitionTo('screen-subjects');
        }

        // Event listeners
        document.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !document.getElementById('screen-game').classList.contains('hidden')) {
                checkAnswer();
            }
        });

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

        // Initialize
        init3D();
        animate();
    </script>
</body>
</html>